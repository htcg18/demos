// Generated by CoffeeScript 1.3.3
(function() {
  var fs, getType, log, magic, mmm, os, path, _;

  log = console.log;

  fs = require('fs');

  os = require('os');

  path = require('path');

  _ = require('underscore');

  mmm = require('mmmagic');

  magic = new mmm.Magic(mmm.MAGIC_MIME_TYPE);

  process.env['HOSTNAME'] = os.hostname();

  getType = function(stat) {
    if (stat.isFile()) {
      return 'file';
    }
    if (stat.isDirectory()) {
      return 'directory';
    }
    if (stat.isBlockDevice()) {
      return 'block';
    }
    if (stat.isCharacterDevice()) {
      return 'character';
    }
    if (stat.isSymbolicLink()) {
      return 'symlink';
    }
    if (stat.isFIFO()) {
      return 'fifo';
    }
    if (stat.isSocket()) {
      return 'socket';
    }
  };

  module.exports = {
    env: function(args, cb) {
      var arg, values, _i, _len;
      values = [];
      for (_i = 0, _len = args.length; _i < _len; _i++) {
        arg = args[_i];
        values.push(process.env[arg]);
      }
      return cb(values);
    },
    ls: function(args, cb) {
      var dirname;
      dirname = args[0];
      if (dirname[0] !== '/') {
        dirname = path.resolve('apps', dirname);
      }
      return fs.readdir(dirname, function(err, basenames) {
        var after, basename, stats, _i, _len, _results;
        if (err) {
          throw err;
        }
        stats = [];
        after = _.after(basenames.length, function() {
          return cb(stats);
        });
        _results = [];
        for (_i = 0, _len = basenames.length; _i < _len; _i++) {
          basename = basenames[_i];
          _results.push((function(basename) {
            var absolute;
            absolute = path.join(dirname, basename);
            return fs.stat(absolute, function(err, stat) {
              if (err) {
                throw err;
              }
              stat.basename = basename;
              stat.type = getType(stat);
              stats.push(stat);
              return after();
            });
          })(basename));
        }
        return _results;
      });
    }
  };

}).call(this);
